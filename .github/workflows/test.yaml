# .github/workflows/ci.yml
name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    name: build-test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: cargo build --locked --features cli --bins --all-targets
          
      - name: Headless smoke test (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
         set -euo pipefail
         BIN_VIEWER="target/debug/asimov-image-viewer"
         BIN_READER="target/debug/asimov-image-reader"
         
         # Make a 2x2 ASCII PPM (P3)
         cat > test.ppm <<'PPM'
         P3
         2 2
         255
         255 0 0   0 255 0
         0 0 255   255 255 255
         PPM
         
         # Reader prints one JSON-LD line -> pipe to viewer (headless)
         "$BIN_READER" test.ppm | "$BIN_VIEWER" --headless --verbose

      - name: Headless smoke test (Windows PowerShell)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
         $ErrorActionPreference = "Stop"
         $viewer = "target\debug\asimov-image-viewer.exe"
         $reader = "target\debug\asimov-image-reader.exe"
         
         # Create 2x2 PPM (ASCII P3)
         @'
         P3
         2 2
         255
         255 0 0   0 255 0
         0 0 255   255 255 255
         '@ | Set-Content -NoNewline -Encoding ascii test.ppm
         
         # Pipe real JSON-LD from reader into viewer
         & $reader test.ppm | & $viewer --headless --verbose